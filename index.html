<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fishing Pro - Anti-Cheat Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        body { margin: 0; padding: 0; background: #001e30; overflow: hidden; touch-action: none; font-family: 'Segoe UI', sans-serif; color: white; }
        #top-ui { position: absolute; top: 10px; width: 100%; display: flex; justify-content: center; gap: 8px; z-index: 100; pointer-events: none; }
        .stat-box { background: rgba(0, 30, 50, 0.9); padding: 5px 12px; border-radius: 12px; border: 1px solid rgba(0, 242, 255, 0.3); font-weight: bold; font-size: 11px; display: flex; align-items: center; gap: 4px; }
        
        .modal { display: none; position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 20, 35, 0.98); padding: 20px; border-radius: 25px; border: 2px solid #00f2ff; z-index: 3000; width: 85%; max-width: 320px; text-align: center; }
        .close-btn { position: absolute; top: 10px; right: 15px; background: #ff4757; color: white; border: none; width: 28px; height: 28px; border-radius: 50%; font-weight: bold; cursor: pointer; }
        
        #nav-bar { position: absolute; bottom: 0; width: 100%; height: 65px; background: rgba(0, 15, 25, 0.98); border-top: 1.5px solid rgba(0, 242, 255, 0.3); display: flex; justify-content: space-around; align-items: center; z-index: 2000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #888; cursor: pointer; flex: 1; }
        .nav-text { font-size: 8px; font-weight: bold; text-transform: uppercase; margin-top: 3px; }
        
        .btn-action { background: linear-gradient(135deg, #00d2ff, #0072ff); color: #fff; border: none; padding: 12px; width: 100%; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 8px; font-size: 13px; }

        /* Anti-Cheat Lock UI */
        #force-lock { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 10000; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        .progress-container { width: 80%; height: 10px; background: #333; border-radius: 10px; margin: 20px 0; overflow: hidden; border: 1px solid #00f2ff; }
        .progress-bar { width: 0%; height: 100%; background: #00f2ff; }
        #lock-timer { font-size: 70px; font-weight: bold; color: #ffd700; }
        .warning-text { color: #ff4757; font-weight: bold; font-size: 14px; margin-top: 10px; display: none; }
        
        #ad-screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 15, 25, 0.95); z-index: 5000; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        canvas { display: block; }
        input, select { width: 90%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: none; }
    </style>
</head>
<body>

    <div id="force-lock">
        <h2 id="lock-title" style="color:#00f2ff; margin:0;">VERIFYING...</h2>
        <div id="cheat-warn" class="warning-text">‚ö†Ô∏è DON'T COME BACK! STAY ON AD PAGE</div>
        <div class="progress-container"><div id="myBar" class="progress-bar"></div></div>
        <div id="lock-timer">10</div>
        <button class="btn-action" style="width:220px; background:#ffd700; color:#000;" onclick="window.open(ADSTERRA_SMARTLINK, '_blank')">üöÄ GO BACK TO AD PAGE</button>
    </div>

    <div id="top-ui">
        <div class="stat-box">üí∞ $<span id="coins">0.000000</span></div>
        <div class="stat-box">‚ö° <span id="energy-count">15</span>/15</div>
        <div class="stat-box">üíé <span id="dia-count">0</span></div>
    </div>

    <div id="ad-screen">
        <h2 style="color:#ffd700;">‚ö° NO ENERGY</h2>
        <button class="btn-action" style="width: 200px; background:#ffd700; color:000;" onclick="startVerifiedAd('energy')">üì∫ REFILL ENERGY (AD)</button>
    </div>

    <div id="withdraw-modal" class="modal">
        <button class="close-btn" onclick="closeAll()">√ó</button>
        <h3 style="color:#27ae60;">üí∏ WITHDRAW</h3>
        <input type="number" id="binance-uid" placeholder="Binance UID">
        <select id="wd-amount">
            <option value="5">5.00 USD (5,000 Diamonds)</option>
            <option value="10">10.00 USD (10,000 Diamonds)</option>
        </select>
        <button class="btn-action" style="background:#27ae60;" onclick="submitWithdraw()">SUBMIT REQUEST</button>
    </div>

    <div id="diamond-modal" class="modal">
        <button class="close-btn" onclick="closeAll()">√ó</button>
        <h3 style="color:#ff00e6;">üíé DIAMOND TASK</h3>
        <button id="dia-ad-btn" class="btn-action" onclick="startVerifiedAd('dia')">üì∫ WATCH AD (<span id="ad-count-view">3</span>/3)</button>
    </div>

    <div id="refer-modal" class="modal">
        <button class="close-btn" onclick="closeAll()">√ó</button>
        <h3>üë• REFERRAL</h3>
        <div id="refer-link-box" style="font-size:12px; background:rgba(0,242,255,0.1); border:1px dashed #00f2ff; padding:15px; border-radius:12px; word-break:break-all; color:#00f2ff; cursor:pointer;" onclick="copyReferLink()">Loading...</div>
        <button class="btn-action" onclick="copyReferLink()">COPY LINK</button>
    </div>

    <div id="nav-bar">
        <div class="nav-item" onclick="openShop('refer-modal')"><span>üë•</span><span class="nav-text">Refer</span></div>
        <div class="nav-item" onclick="openShop('withdraw-modal')"><span>üí∞</span><span class="nav-text">Wallet</span></div>
        <div class="nav-item" onclick="openShop('diamond-modal')"><span>üíé</span><span class="nav-text">Diamond</span></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const ADSTERRA_SMARTLINK = "https://www.effectivegatecpm.com/rarb5qds06?key=79349eb6a9357e2e416a3ef19425a5c1";
        const tg = window.Telegram.WebApp; tg.expand();
        const userId = tg.initDataUnsafe?.user?.id.toString() || "test_user";
        const BOT_USERNAME = "Referralincamebd01311_bot";

        const firebaseConfig = {
            apiKey: "AIzaSyA-2VRyhIktuWhesvHRa2lkq-G-PRWBQ8S5RP",
            databaseURL: "https://royaldiamondbot-default-rtdb.firebaseio.com",
            projectId: "royaldiamondbot",
            appId: "1:156914195366:web:e5ab56df62ecbf90550d67"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let balance = 0, energy = 15, diamonds = 0, adCount = 0;
        let adStartTime = 0, elapsedWhileHidden = 0, timerActive = false, rewardType = "";
        let fishes = [];

        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let hook = { x: canvas.width / 2, y: 80, state: 'idle' };

        // --- Improved Anti-Cheat Timer ---
        function startVerifiedAd(type) {
            rewardType = type;
            adStartTime = Date.now();
            elapsedWhileHidden = 0;
            timerActive = true;
            window.open(ADSTERRA_SMARTLINK, '_blank');
            document.getElementById("force-lock").style.display = "flex";
        }

        setInterval(() => {
            if (!timerActive) return;

            if (document.visibilityState === 'visible') {
                // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶™‡¶ú ‡¶è‡¶¨‡¶Ç ‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶®‡¶ø‡¶Ç
                document.getElementById("lock-title").innerText = "‚ö†Ô∏è PAUSED";
                document.getElementById("cheat-warn").style.display = "block";
            } else {
                // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶°‡ßá ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶ö‡¶≤‡¶¨‡ßá
                document.getElementById("lock-title").innerText = "VERIFYING...";
                document.getElementById("cheat-warn").style.display = "none";
                
                let now = Date.now();
                elapsedWhileHidden = (now - adStartTime) / 1000;
            }

            let remaining = 10 - elapsedWhileHidden;
            if (remaining > 0) {
                document.getElementById("lock-timer").innerText = Math.ceil(remaining);
                document.getElementById("myBar").style.width = (Math.min(elapsedWhileHidden, 10) / 10 * 100) + "%";
            } else {
                completeAdTask();
            }
        }, 500);

        function completeAdTask() {
            timerActive = false;
            document.getElementById("force-lock").style.display = "none";
            
            if(rewardType === 'energy') energy = 15;
            else if(rewardType === 'dia') {
                diamonds += 10; adCount++;
                if(adCount >= 3) adCount = 0;
            }
            saveData();
            setTimeout(() => alert("Verified! Reward Added Successfully."), 200);
        }

        function submitWithdraw() {
            const uid = document.getElementById('binance-uid').value;
            const amt = parseInt(document.getElementById('wd-amount').value);
            const cost = amt * 1000;
            if(!uid) return alert("Enter Binance ID!");
            if(diamonds < cost) return alert(`Need ${cost} Diamonds!`);
            db.ref('Withdraw_Requests/' + Date.now()).set({ userId, binanceID: uid, amount: amt + " USD", status: "Pending" });
            diamonds -= cost; saveData(); closeAll(); alert("Requested!");
        }

        // --- Fishing Gameplay Logic ---
        function drawFish(x, y, color, dir) {
            ctx.save(); ctx.translate(x, y); if (dir === -1) ctx.scale(-1, 1);
            ctx.fillStyle = color; ctx.beginPath(); ctx.ellipse(0, 0, 20, 10, 0, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.moveTo(-18, 0); ctx.lineTo(-28, -8); ctx.lineTo(-28, 8); ctx.closePath(); ctx.fill();
            ctx.restore();
        }

        function draw() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            let grad = ctx.createLinearGradient(0,0,0,canvas.height); grad.addColorStop(0,"#00a8e8"); grad.addColorStop(1,"#001e30");
            ctx.fillStyle = grad; ctx.fillRect(0,0,canvas.width, canvas.height);

            if(hook.state === 'dropping') { hook.y += 12; if(hook.y > canvas.height - 100) hook.state = 'retracting'; }
            else if(hook.state === 'retracting') { hook.y -= 12; if(hook.y <= 80) { hook.state = 'idle'; checkCatch(); } }

            ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(canvas.width / 2, 0); ctx.lineTo(hook.x, hook.y); ctx.stroke();
            ctx.strokeStyle = "#ddd"; ctx.lineWidth = 4; ctx.beginPath(); ctx.arc(hook.x, hook.y + 10, 10, 0, Math.PI); ctx.stroke();

            while(fishes.length < 15) { fishes.push({ x: Math.random()*canvas.width, y: 200+Math.random()*(canvas.height-300), speed: 1.5, dir: Math.random()>0.5?1:-1, caught: false, color: `hsl(${Math.random()*360}, 70%, 50%)` }); }
            fishes.forEach(f => {
                if(f.caught) { f.x = hook.x; f.y = hook.y + 25; }
                else {
                    f.x += f.speed * f.dir;
                    if(f.x > canvas.width+30) f.dir = -1; if(f.x < -30) f.dir = 1;
                    if(hook.state === 'retracting' && Math.hypot(hook.x-f.x, hook.y-f.y) < 30) f.caught = true;
                }
                drawFish(f.x, f.y, f.color, f.dir);
            });
            requestAnimationFrame(draw);
        }

        function checkCatch() { 
            let caught = fishes.filter(f => f.caught).length;
            if(caught > 0) { balance += caught * 0.00005; fishes = fishes.filter(f => !f.caught); saveData(); }
        }

        window.onclick = () => {
            if(document.querySelector('.modal[style*="block"]') || energy <= 0 || hook.state !== 'idle' || timerActive) return;
            hook.state = 'dropping'; energy--; saveData();
        };

        function saveData() { db.ref('users/' + userId).update({ balance, energy, diamonds, adCount }); }
        db.ref('users/' + userId).on('value', (snap) => {
            const val = snap.val(); if(val) {
                balance = val.balance || 0; energy = val.energy !== undefined ? val.energy : 15;
                diamonds = val.diamonds || 0; adCount = val.adCount || 0;
                document.getElementById("coins").innerText = balance.toFixed(6);
                document.getElementById("energy-count").innerText = energy;
                document.getElementById("dia-count").innerText = diamonds;
                document.getElementById("ad-count-view").innerText = 3 - adCount;
                document.getElementById("ad-screen").style.display = (energy <= 0) ? 'flex' : 'none';
                document.getElementById("refer-link-box").innerText = `https://t.me/${BOT_USERNAME}/play?startapp=${userId}`;
            }
        });

        function copyReferLink() { navigator.clipboard.writeText(document.getElementById("refer-link-box").innerText).then(() => alert('Copied!')); }
        function openShop(id) { closeAll(); document.getElementById(id).style.display = "block"; }
        function closeAll() { document.querySelectorAll('.modal').forEach(m => m.style.display="none"); }
        draw();
    </script>
</body>
    </html>
    
