<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fishing Pro - Original Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        body { margin: 0; padding: 0; background: #001e30; overflow: hidden; touch-action: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: white; }
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #003a5d 0%, #001e30 100%); z-index: 30000; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .auth-box { background: rgba(0, 30, 50, 0.95); padding: 30px; border-radius: 25px; border: 2px solid #00f2ff; width: 85%; max-width: 320px; box-shadow: 0 0 40px rgba(0, 242, 255, 0.4); }
        .auth-input { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 1px solid #00f2ff; background: #001525; color: white; box-sizing: border-box; font-size: 16px; text-align: center; outline: none; }
        #top-ui { position: absolute; top: 15px; width: 100%; display: flex; justify-content: center; gap: 10px; z-index: 100; pointer-events: none; }
        .stat-box { background: rgba(0, 30, 50, 0.85); padding: 6px 14px; border-radius: 20px; border: 1.5px solid rgba(0, 242, 255, 0.5); font-weight: 800; font-size: 12px; display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #force-lock { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        #lock-info-text { font-size: 20px; font-weight: bold; color: #ffd700; margin-bottom: 25px; }
        .modal { display: none; position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); background: #001e30; padding: 25px; border-radius: 25px; border: 2px solid #00f2ff; z-index: 3000; width: 88%; max-width: 340px; text-align: center; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .close-btn { position: absolute; top: 12px; right: 15px; background: #ff4757; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; font-weight: bold; cursor: pointer; }
        .btn-action { background: linear-gradient(180deg, #00f2ff, #0072ff); color: #fff; border: none; padding: 14px; width: 100%; border-radius: 15px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        .btn-gray { background: #555 !important; color: #aaa !important; cursor: not-allowed !important; transform: none !important; box-shadow: none !important; pointer-events: none; }
        .task-card { background: rgba(255,255,255,0.07); padding: 12px; border-radius: 18px; margin-bottom: 15px; border: 1px solid rgba(0,242,255,0.15); }
        #nav-bar { position: absolute; bottom: 0; width: 100%; height: 75px; background: #000d16; border-top: 2px solid #00f2ff; display: flex; justify-content: space-around; align-items: center; z-index: 2000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #00f2ff; cursor: pointer; opacity: 0.8; transition: 0.3s; }
        .nav-item:active { transform: scale(0.9); opacity: 1; }
        .nav-text { font-size: 11px; font-weight: bold; margin-top: 5px; }
        canvas { display: block; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box">
            <h1 style="color:#00f2ff; margin:0; font-size: 28px;">FISHING PRO</h1>
            <p style="font-size:13px; color:#00d2ff; margin:10px 0 20px;">Premium Fishing Experience</p>
            <input type="number" id="reg-phone" class="auth-input" placeholder="Phone Number">
            <input type="password" id="reg-pass" class="auth-input" placeholder="6-Digit Password" maxlength="6">
            <button class="btn-action" onclick="processLogin()">START GAME</button>
        </div>
    </div>

    <div id="force-lock">
        <div id="lock-info-text">VERIFYING AD STATUS...</div>
        <button class="btn-action" style="width:240px; background:#ffd700; color:#000;" onclick="window.open(ADSTERRA_SMARTLINK, '_blank')">ðŸš€ RE-OPEN AD</button>
    </div>

    <div id="top-ui">
        <div class="stat-box">ðŸ’° $<span id="coins">0.000000</span></div>
        <div class="stat-box">âš¡ <span id="energy-count">15</span>/15</div>
        <div class="stat-box">ðŸ’Ž <span id="dia-count">0</span></div>
    </div>

    <div id="tasks-modal" class="modal">
        <button class="close-btn" onclick="closeAll()">Ã—</button>
        <h3 style="color:#00f2ff; margin-bottom:20px;">EXCLUSIVE TASKS</h3>
        <div class="task-card">
            <p style="font-size:12px; margin:0 0 8px;">Join Telegram Community</p>
            <button id="btn-t1" class="btn-action" onclick="doLinkTask('t1', 'https://t.me/FishingProCommunity')">JOIN CHANNEL ($0.20)</button>
        </div>
        <div class="task-card">
            <p style="font-size:12px; margin:0 0 8px;">Subscribe Official YouTube</p>
            <button id="btn-t2" class="btn-action" onclick="doLinkTask('t2', 'https://www.youtube.com/@FishProZoneYT')">SUBSCRIBE NOW ($0.20)</button>
        </div>
        <div class="task-card">
            <p style="font-size:12px; margin:0 0 8px;">Secret Video Task</p>
            <div id="t3-ui">
                <button class="btn-action" style="background:#ff4757;" onclick="window.open('https://youtu.be/3vRDSaiZv_s', '_blank')">WATCH VIDEO</button>
                <input type="text" id="v-code-input" placeholder="Enter Code" style="width:90%; padding:10px; margin-top:10px; border-radius:10px; border:1px solid #00f2ff; background:#001525; color:white;">
                <button class="btn-action" onclick="verifyVideoCode()">SUBMIT CODE</button>
            </div>
            <p id="t3-done-msg" style="display:none; color:#00f2ff; font-weight:bold;">COMPLETED âœ…</p>
        </div>
    </div>

    <div id="energy-modal" class="modal">
        <h3 style="color:#ffd700;">LOW ENERGY</h3>
        <p>Watch a short video to refill 15 Energy</p>
        <button class="btn-action" onclick="startAd('energy')">ðŸ“º WATCH AD</button>
    </div>

    <div id="diamond-modal" class="modal">
        <button class="close-btn" onclick="closeAll()">Ã—</button>
        <h3 style="color:#ff00e6;">DIAMOND FARM</h3>
        <p style="font-size:12px; color:#aaa;">Complete 3 Ads to get 30 Diamonds</p>
        <button id="dia-ad-btn" class="btn-action" onclick="startAd('dia')">ðŸ“º WATCH AD (<span id="task-count">3</span>/3)</button>
        <div id="cooldown-area" style="display:none; margin-top:15px; border: 1px solid #00f2ff; padding: 10px; border-radius: 15px;">
            <p style="color:#aaa; font-size:11px;">Next attempt in:</p>
            <p id="cooldown-timer" style="color:#00f2ff; font-size:24px; font-weight:bold;">05:00</p>
        </div>
    </div>

    <div id="refer-modal" class="modal">
        <button class="close-btn" onclick="closeAll()">Ã—</button>
        <h3 style="color:#ffd700;">INVITE FRIENDS</h3>
        <p style="font-size:11px; color:#aaa; margin-bottom:15px;">Earn commissions from every friend join</p>
        <div id="refer-link-box" style="font-size:11px; padding:12px; border:1px dashed #00f2ff; color:#00f2ff; background:rgba(0,0,0,0.3); border-radius:10px; word-break:break-all;">Loading...</div>
        <button class="btn-action" onclick="copyReferLink()">COPY REFERRAL LINK</button>
    </div>

    <div id="withdraw-modal" class="modal">
        <button class="close-btn" onclick="closeAll()">Ã—</button>
        <h3 style="color:#27ae60;">WALLET WITHDRAW</h3>
        <input type="number" id="binance-uid" placeholder="Binance UID" class="auth-input">
        <select id="withdraw-amount" style="width:100%; padding:14px; border-radius:12px; background:#001525; color:white; border:1px solid #00f2ff; margin-bottom:15px;">
            <option value="5000">5.00 USD (5,000 Diamonds)</option>
            <option value="10000">10.00 USD (10,000 Diamonds)</option>
        </select>
        <button class="btn-action" style="background: #27ae60;" onclick="submitWithdraw()">CONFIRM WITHDRAW</button>
    </div>

    <div id="nav-bar">
        <div class="nav-item" onclick="openShop('tasks-modal')"><span>ðŸš€</span><span class="nav-text">Tasks</span></div>
        <div class="nav-item" onclick="openShop('refer-modal')"><span>ðŸ‘¥</span><span class="nav-text">Refer</span></div>
        <div class="nav-item" onclick="openShop('withdraw-modal')"><span>ðŸ’°</span><span class="nav-text">Wallet</span></div>
        <div class="nav-item" onclick="openShop('diamond-modal')"><span>ðŸ’Ž</span><span class="nav-text">Diamond</span></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const ADSTERRA_SMARTLINK = "https://www.effectivegatecpm.com/rarb5qds06?key=79349eb6a9357e2e416a3ef19425a5c1";
        const tg = window.Telegram.WebApp;
        const userId = tg.initDataUnsafe?.user?.id.toString() || "player_one";

        const firebaseConfig = {
            apiKey: "AIzaSyA-2VRyhIktuWhesvHRa2lkq-G-PRWBQ8S5RP",
            databaseURL: "https://royaldiamondbot-default-rtdb.firebaseio.com",
            projectId: "royaldiamondbot",
            appId: "1:156914195366:web:e5ab56df62ecbf90550d67"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let balance = 0, energy = 15, diamonds = 0, tasksDone = 0, nextResetTime = 0;
        let t1_done = false, t2_done = false, t3_done = false;
        let adStartTime = 0, timerActive = false, rewardType = "", isUserLoggedIn = false;
        let fishes = [];

        function processLogin() {
            const phone = document.getElementById('reg-phone').value;
            const pass = document.getElementById('reg-pass').value;
            if(phone.length < 8) return alert("Invalid Phone Number");
            db.ref('users/' + userId + '/security').once('value').then(snap => {
                if(snap.val()) startTheGame();
                else db.ref('users/' + userId + '/security').set({ phone, password: pass }).then(() => startTheGame());
            });
        }

        function startTheGame() {
            localStorage.setItem('fish_logged_' + userId, 'true');
            document.getElementById('auth-screen').style.display = 'none';
            isUserLoggedIn = true;
            initUserData();
        }

        window.onload = () => {
            if(localStorage.getItem('fish_logged_' + userId) === 'true') {
                document.getElementById('auth-screen').style.display = 'none';
                isUserLoggedIn = true;
                initUserData();
            }
        };

        function initUserData() {
            db.ref('users/' + userId).on('value', snap => {
                const v = snap.val(); if(v) {
                    balance = v.balance || 0; energy = v.energy ?? 15; diamonds = v.diamonds || 0;
                    tasksDone = v.tasksDone || 0; nextResetTime = v.nextResetTime || 0;
                    t1_done = v.t1_done || false; t2_done = v.t2_done || false; t3_done = v.t3_done || false;
                    
                    document.getElementById("coins").innerText = balance.toFixed(6);
                    document.getElementById("energy-count").innerText = energy;
                    document.getElementById("dia-count").innerText = diamonds;
                    document.getElementById("task-count").innerText = Math.max(0, 3 - tasksDone);
                    document.getElementById("refer-link-box").innerText = `https://t.me/Referralincamebd01311_bot/play?startapp=${userId}`;

                    if(t1_done) lockBtn("btn-t1");
                    if(t2_done) lockBtn("btn-t2");
                    if(t3_done) { 
                        document.getElementById("t3-ui").style.display = "none"; 
                        document.getElementById("t3-done-msg").style.display = "block";
                    }

                    const diaBtn = document.getElementById("dia-ad-btn");
                    if (tasksDone >= 3 || (nextResetTime > 0 && nextResetTime > Date.now())) {
                        diaBtn.classList.add("btn-gray");
                    } else {
                        diaBtn.classList.remove("btn-gray");
                    }
                }
            });
        }

        function lockBtn(id) {
            const el = document.getElementById(id);
            if(el) {
                el.classList.add("btn-gray");
                el.innerText = "COMPLETED";
                el.onclick = null;
            }
        }

        function startAd(type) {
            if (type === 'dia' && (tasksDone >= 3 || nextResetTime > Date.now())) return;
            rewardType = type; adStartTime = Date.now(); timerActive = true;
            window.open(ADSTERRA_SMARTLINK, '_blank');
            closeAll();
            document.getElementById("force-lock").style.display = "flex";
        }

        setInterval(() => {
            if (!isUserLoggedIn) return;
            if (nextResetTime > 0) {
                let diff = Math.floor((nextResetTime - Date.now()) / 1000);
                if (diff <= 0) { 
                    tasksDone = 0; nextResetTime = 0; saveData(); 
                    document.getElementById("cooldown-area").style.display = "none";
                } else {
                    let m = Math.floor(diff/60); let s = diff%60;
                    document.getElementById("cooldown-timer").innerText = `${m}:${s.toString().padStart(2,'0')}`;
                    document.getElementById("cooldown-area").style.display = "block";
                }
            }
            if (timerActive) {
                let elapsed = (Date.now() - adStartTime) / 1000;
                if (elapsed >= 20.5) { 
                    timerActive = false;
                    document.getElementById("force-lock").style.display = "none";
                    if(rewardType === 'dia') { 
                        diamonds += 10; tasksDone++; 
                        if(tasksDone >= 3) nextResetTime = Date.now() + (5 * 60 * 1000); 
                    } else if(rewardType === 'energy') { energy = 15; }
                    saveData();
                }
            }
        }, 500);

        // --- Realistic Drawing Engine ---
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let hook = { x: canvas.width/2, y: 80, state: 'idle' };

        // Realistic Metallic Hook
        function drawHook(ctx, x, y) {
            ctx.save();
            // Fishing Line
            ctx.strokeStyle = "#ffffff"; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(canvas.width/2, 0); ctx.lineTo(x, y); ctx.stroke();
            
            // Hook Body (Silver Metallic)
            ctx.translate(x, y);
            ctx.strokeStyle = "#bdc3c7"; ctx.lineWidth = 3; ctx.lineCap = "round";
            ctx.beginPath();
            ctx.arc(0, 10, 8, 0.2, Math.PI - 0.2, false); 
            ctx.stroke();
            
            // Hook Barb (The Sharp Point)
            ctx.fillStyle = "#bdc3c7";
            ctx.beginPath();
            ctx.moveTo(-8, 10);
            ctx.lineTo(-12, 5);
            ctx.lineTo(-6, 8);
            ctx.fill();
            ctx.restore();
        }

        // Realistic Fish with Scales, Fins and Tail Animation
        function drawFish(ctx, f) {
            ctx.save();
            ctx.translate(f.x, f.y);
            if (f.dir === -1) ctx.scale(-1, 1);

            let time = Date.now() * 0.005;
            let tailWag = Math.sin(time + f.speed) * 0.3;

            // Body Gradient (Metallic Scale Look)
            let grad = ctx.createRadialGradient(5, -5, 2, 0, 0, 20);
            grad.addColorStop(0, "rgba(255,255,255,0.4)");
            grad.addColorStop(1, f.color);
            ctx.fillStyle = grad;

            // Main Body
            ctx.beginPath();
            ctx.ellipse(0, 0, 25, 12, 0, 0, Math.PI * 2);
            ctx.fill();

            // Scales (Subtle Pattern)
            ctx.strokeStyle = "rgba(0,0,0,0.1)";
            ctx.lineWidth = 0.5;
            for(let i=-15; i<15; i+=5) {
                ctx.beginPath(); ctx.arc(i, 0, 8, 0, Math.PI); ctx.stroke();
            }

            // Animated Fins
            ctx.fillStyle = f.color;
            let finMove = Math.sin(time) * 5;
            ctx.beginPath(); ctx.moveTo(-5, -10); ctx.lineTo(5 + finMove, -18); ctx.lineTo(10, -10); ctx.fill(); // Top
            ctx.beginPath(); ctx.moveTo(-5, 10); ctx.lineTo(2 + finMove, 16); ctx.lineTo(8, 10); ctx.fill(); // Bottom

            // Animated Tail
            ctx.save();
            ctx.translate(-22, 0);
            ctx.rotate(tailWag);
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(-15, -12);
            ctx.lineTo(-10, 0);
            ctx.lineTo(-15, 12);
            ctx.closePath(); ctx.fill();
            ctx.restore();

            // Real Eye
            ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(16, -4, 4, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(18, -4, 2, 0, Math.PI*2); ctx.fill();
            
            ctx.restore();
        }

        function createFish() {
            return { 
                x: Math.random()*canvas.width, 
                y: 250+Math.random()*(canvas.height-400), 
                speed: 0.8+Math.random()*1.5, 
                dir: Math.random()>0.5?1:-1, 
                color: `hsl(${Math.random()*360}, 60%, 50%)`, 
                caught: false 
            };
        }
        for(let i=0; i<10; i++) fishes.push(createFish());

        function draw() {
            if(!isUserLoggedIn) { requestAnimationFrame(draw); return; }
            let grad = ctx.createLinearGradient(0,0,0,canvas.height);
            grad.addColorStop(0, "#005c97"); grad.addColorStop(1, "#001e30");
            ctx.fillStyle = grad; ctx.fillRect(0,0,canvas.width, canvas.height);

            if(hook.state === 'dropping') { hook.y += 12; if(hook.y > canvas.height-120) hook.state = 'retracting'; }
            else if(hook.state === 'retracting') { hook.y -= 12; if(hook.y <= 80) { hook.state = 'idle'; checkCatch(); } }

            drawHook(ctx, hook.x, hook.y);
            fishes.forEach(f => {
                if(f.caught) { f.x = hook.x; f.y = hook.y + 15; }
                else { 
                    f.x += f.speed * f.dir; 
                    if(f.x > canvas.width+50) f.dir = -1; 
                    if(f.x < -50) f.dir = 1; 
                    if(hook.state === 'retracting' && Math.hypot(hook.x-f.x, hook.y-f.y) < 28) f.caught = true; 
                }
                drawFish(ctx, f);
            });
            requestAnimationFrame(draw);
        }

        function checkCatch() {
            let caught = fishes.filter(f => f.caught);
            if(caught.length > 0) {
                balance += caught.length * 0.000005;
                fishes = fishes.filter(f => !f.caught);
                while(fishes.length < 10) fishes.push(createFish());
                saveData();
            }
        }

        window.onclick = (e) => {
            if(!isUserLoggedIn || e.target.tagName !== 'CANVAS' || hook.state !== 'idle' || timerActive) return;
            if(energy <= 0) { openShop('energy-modal'); return; }
            hook.state = 'dropping'; energy--; saveData();
        };

        function doLinkTask(ty
