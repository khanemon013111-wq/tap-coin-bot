<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fishing Pro - Dadu Special Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        body { margin: 0; padding: 0; background: #001e30; overflow: hidden; touch-action: none; font-family: 'Segoe UI', sans-serif; color: white; }
        #top-ui { position: absolute; top: 10px; width: 100%; display: flex; justify-content: center; gap: 8px; z-index: 100; pointer-events: none; }
        .stat-box { background: rgba(0, 30, 50, 0.9); padding: 5px 12px; border-radius: 12px; border: 1px solid rgba(0, 242, 255, 0.3); font-weight: bold; font-size: 11px; display: flex; align-items: center; gap: 4px; }
        
        /* Ad Lock Overlay */
        #force-lock { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 10000; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        .progress-container { width: 80%; height: 12px; background: #222; border-radius: 10px; margin: 20px 0; overflow: hidden; border: 1px solid #00f2ff; }
        .progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #00f2ff, #0072ff); }
        #lock-timer { font-size: 60px; font-weight: bold; color: #ffd700; }

        /* Modals */
        .modal { display: none; position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 20, 35, 0.98); padding: 25px; border-radius: 25px; border: 2px solid #00f2ff; z-index: 3000; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 0 20px rgba(0, 242, 255, 0.2); }
        .close-btn { position: absolute; top: 10px; right: 15px; background: #ff4757; color: white; border: none; width: 28px; height: 28px; border-radius: 50%; font-weight: bold; cursor: pointer; }
        .btn-action { background: linear-gradient(135deg, #00d2ff, #0072ff); color: #fff; border: none; padding: 12px; width: 100%; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 14px; }
        
        /* Wallet UI */
        .wallet-card { background: #f3ba2f; color: #000; padding: 10px; border-radius: 12px; margin-bottom: 15px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; }
        input, select { width: 95%; padding: 12px; margin-bottom: 12px; border-radius: 10px; border: 1px solid #00f2ff; background: #001525; color: white; }

        #nav-bar { position: absolute; bottom: 0; width: 100%; height: 65px; background: rgba(0, 15, 25, 0.98); border-top: 1.5px solid rgba(0, 242, 255, 0.3); display: flex; justify-content: space-around; align-items: center; z-index: 2000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #00f2ff; cursor: pointer; flex: 1; }
        .nav-text { font-size: 10px; font-weight: bold; margin-top: 4px; }
        canvas { display: block; }
    </style>
</head>
<body>

    <div id="force-lock">
        <h2 style="color:#00f2ff; margin:0;">VERIFYING AD...</h2>
        <div class="progress-container"><div id="myBar" class="progress-bar"></div></div>
        <div id="lock-timer">10</div>
        <p id="timer-status" style="font-size: 12px; color: #aaa;">Stay on the ad page to continue</p>
        <button class="btn-action" style="width:200px; background:#ffd700; color:#000;" onclick="window.open(ADSTERRA_SMARTLINK, '_blank')">ðŸš€ RE-OPEN AD</button>
    </div>

    <div id="top-ui">
        <div class="stat-box">ðŸ’° $<span id="coins">0.000000</span></div>
        <div class="stat-box">âš¡ <span id="energy-count">15</span>/15</div>
        <div class="stat-box">ðŸ’Ž <span id="dia-count">0</span></div>
    </div>

    <div id="withdraw-modal" class="modal">
        <button class="close-btn" onclick="closeAll()">Ã—</button>
        <div class="wallet-card">
            <img src="https://upload.wikimedia.org/wikipedia/commons/e/e8/Binance_Logo.png" width="20" alt="Binance"> 
            BINANCE WITHDRAW
        </div>
        <input type="number" id="binance-uid" placeholder="Enter Binance UID">
        <select id="withdraw-amount">
            <option value="5000">5.00 USDT (5k Diamonds)</option>
            <option value="10000">10.00 USDT (10k Diamonds)</option>
        </select>
        <button class="btn-action" style="background: #27ae60;" onclick="submitWithdraw()">SUBMIT WITHDRAW</button>
    </div>

    <div id="diamond-modal" class="modal">
        <button class="close-btn" onclick="closeAll()">Ã—</button>
        <h3 style="color:#ff00e6;">ðŸ’Ž DIAMOND TASK</h3>
        <p style="font-size:11px; color:#aaa;">1 Ad = 1 Diamond (Max 3 Ads)</p>
        <button id="dia-ad-btn" class="btn-action" onclick="startVerifiedAd()">ðŸ“º WATCH AD (<span id="task-count">3</span>/3)</button>
        <div id="cooldown-area" style="display:none; margin-top:10px; color:#ffd700; font-weight:bold;">Wait for: <span id="cooldown-timer">05:00</span></div>
    </div>

    <div id="refer-modal" class="modal">
        <button class="close-btn" onclick="closeAll()">Ã—</button>
        <h3 style="color:#ffd700;">ðŸ‘¥ REFERRAL</h3>
        <div id="refer-link-box" style="font-size:10px; padding:15px; border:1px dashed #00f2ff; color:#00f2ff; word-break:break-all; border-radius:10px;">Loading...</div>
        <button class="btn-action" onclick="copyReferLink()">COPY LINK</button>
    </div>

    <div id="nav-bar">
        <div class="nav-item" onclick="openShop('refer-modal')"><span>ðŸ‘¥</span><span class="nav-text">Refer</span></div>
        <div class="nav-item" onclick="openShop('withdraw-modal')"><span>ðŸ’°</span><span class="nav-text">Wallet</span></div>
        <div class="nav-item" onclick="openShop('diamond-modal')"><span>ðŸ’Ž</span><span class="nav-text">Diamond</span></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const ADSTERRA_SMARTLINK = "https://www.effectivegatecpm.com/rarb5qds06?key=79349eb6a9357e2e416a3ef19425a5c1";
        const tg = window.Telegram.WebApp;
        const userId = tg.initDataUnsafe?.user?.id.toString() || "test_user";

        const firebaseConfig = { apiKey: "AIzaSyA-2VRyhIktuWhesvHRa2lkq-G-PRWBQ8S5RP", databaseURL: "https://royaldiamondbot-default-rtdb.firebaseio.com", projectId: "royaldiamondbot", appId: "1:156914195366:web:e5ab56df62ecbf90550d67" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let balance = 0, energy = 15, diamonds = 0, tasksDone = 0, nextResetTime = 0;
        let timeLeft = 10, timerInterval = null;

        // --- Ad Verification Logic ---
        function startVerifiedAd() {
            if (tasksDone >= 3) return;
            timeLeft = 10;
            updateTimerUI();
            document.getElementById("force-lock").style.display = "flex";
            window.open(ADSTERRA_SMARTLINK, '_blank');

            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (document.visibilityState === 'hidden') {
                    timeLeft--;
                    updateTimerUI();
                    document.getElementById("timer-status").innerText = "Verifying view...";
                    document.getElementById("timer-status").style.color = "#2ecc71";
                } else {
                    document.getElementById("timer-status").innerText = "PAUSED! Go back to the ad page.";
                    document.getElementById("timer-status").style.color = "#ff4757";
                }
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    completeAdTask();
                }
            }, 1000);
        }

        function updateTimerUI() {
            document.getElementById("lock-timer").innerText = Math.max(0, timeLeft);
            document.getElementById("myBar").style.width = ((10 - timeLeft) / 10 * 100) + "%";
        }

        function completeAdTask() {
            document.getElementById("force-lock").style.display = "none";
            tasksDone++;
            diamonds += 1;
            if(tasksDone >= 3) nextResetTime = Date.now() + (5 * 60 * 1000);
            saveData();
            alert("Reward Received! 1 Diamond Added.");
        }

        // --- Fish Logic (Direction Fixed) ---
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let fishes = [];

        function createFish() {
            let dir = Math.random() > 0.5 ? 1 : -1;
            return { x: dir === 1 ? -60 : canvas.width + 60, y: 250 + Math.random() * (canvas.height - 350), speed: 1 + Math.random(), dir: dir, color: `hsl(${Math.random() * 360}, 70%, 50%)`, caught: false };
        }
        for(let i=0; i<10; i++) fishes.push(createFish());

        function drawFish(ctx, f) {
            ctx.save();
            ctx.translate(f.x, f.y);
            if (f.dir === -1) ctx.scale(-1, 1);
            ctx.fillStyle = f.color;
            ctx.beginPath(); ctx.moveTo(15, 0); ctx.quadraticCurveTo(5, -12, -12, -2); ctx.quadraticCurveTo(-12, 2, 5, 12); ctx.quadraticCurveTo(15, 0, 15, 0); ctx.fill();
            let tail = Math.sin(Date.now() * 0.01 + f.x) * 5;
            ctx.beginPath(); ctx.moveTo(-10, 0); ctx.lineTo(-22, -10 + tail); ctx.lineTo(-18, 0); ctx.lineTo(-22, 10 - tail); ctx.fill();
            ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(8, -3, 2.5, 0, 7); ctx.fill();
            ctx.restore();
        }

        function gameLoop() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle = "#00a8e8"; ctx.fillRect(0,0,canvas.width, canvas.height);
            fishes.forEach(f => {
                f.x += f.speed * f.dir;
                if(f.dir === 1 && f.x > canvas.width + 70) f.x = -70;
                if(f.dir === -1 && f.x < -70) f.x = canvas.width + 70;
                drawFish(ctx, f);
            });
            requestAnimationFrame(gameLoop);
        }

        // --- Data Sync ---
        function saveData() { db.ref('users/' + userId).update({ balance, energy, diamonds, tasksDone, nextResetTime }); }
        db.ref('users/' + userId).on('value', snap => {
            const v = snap.val() || {};
            balance = v.balance || 0; diamonds = v.diamonds || 0; tasksDone = v.tasksDone || 0; nextResetTime = v.nextResetTime || 0; energy = v.energy ?? 15;
            document.getElementById("coins").innerText = balance.toFixed(6);
            document.getElementById("dia-count").innerText = diamonds;
            document.getElementById("energy-count").innerText = energy;
            document.getElementById("task-count").innerText = Math.max(0, 3 - tasksDone);
            document.getElementById("refer-link-box").innerText = `https://t.me/Referralincamebd01311_bot/play?startapp=${userId}`;

            if (nextResetTime > Date.now()) {
                document.getElementById("cooldown-area").style.display = "block";
                document.getElementById("dia-ad-btn").style.display = "none";
                updateCooldownDisplay();
            } else {
                document.getElementById("cooldown-area").style.display = "none";
                document.getElementById("dia-ad-btn").style.display = "block";
            }
        });

        function updateCooldownDisplay() {
            let diff = Math.floor((nextResetTime - Date.now()) / 1000);
            if (diff > 0) {
                let m = Math.floor(diff/60); let s = diff%60;
                document.getElementById("cooldown-timer").innerText = `${m}:${s.toString().padStart(2,'0')}`;
                setTimeout(updateCooldownDisplay, 1000);
            } else {
                tasksDone = 0; nextResetTime = 0; saveData();
            }
        }

        function submitWithdraw() {
            const uid = document.getElementById('binance-uid').value;
            const amt = parseInt(document.getElementById('withdraw-amount').value);
            if(!uid || uid.length < 5 || diamonds < amt) return alert("Check UID or Balance!");
            db.ref('Withdraw_Requests').push({userId, binanceUID: uid, diamondAmount: amt, status: "Pending", timestamp: Date.now()});
            diamonds -= amt; saveData(); closeAll(); alert("Request sent to admin!");
        }

        function copyReferLink() { navigator.clipboard.writeText(document.getElementById("refer-link-box").innerText).then(() => alert("Copied!")); }
        function openShop(id) { closeAll(); document.getElementById(id).style.display = "block"; }
        function closeAll() { document.querySelectorAll('.modal').forEach(m => m.style.display = "none"); }
        gameLoop();
    </script>
</body>
                                              </html>
         
