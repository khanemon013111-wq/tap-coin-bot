<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fishing Pro - Step-by-Step Level</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        body { margin: 0; padding: 0; background: #001e30; overflow: hidden; touch-action: none; font-family: 'Segoe UI', sans-serif; }
        #top-ui { position: absolute; top: 10px; width: 100%; display: flex; justify-content: center; gap: 8px; z-index: 100; pointer-events: none; }
        .stat-box { background: rgba(0, 30, 50, 0.9); backdrop-filter: blur(8px); color: #fff; padding: 5px 12px; border-radius: 12px; border: 1px solid rgba(0, 242, 255, 0.3); font-weight: bold; font-size: 11px; display: flex; align-items: center; gap: 4px; }
        
        .modal { display: none; position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 20, 35, 0.98); padding: 20px; border-radius: 25px; border: 2px solid #00f2ff; color: white; z-index: 3000; width: 85%; max-width: 320px; text-align: center; }
        .close-btn { position: absolute; top: 10px; right: 15px; background: #ff4757; color: white; border: none; width: 28px; height: 28px; border-radius: 50%; font-weight: bold; cursor: pointer; }
        
        #nav-bar { position: absolute; bottom: 0; width: 100%; height: 65px; background: rgba(0, 15, 25, 0.98); border-top: 1.5px solid rgba(0, 242, 255, 0.3); display: flex; justify-content: space-around; align-items: center; z-index: 2000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #888; cursor: pointer; flex: 1; }
        .nav-text { font-size: 9px; font-weight: bold; text-transform: uppercase; margin-top: 3px; }
        
        .btn-action { background: linear-gradient(135deg, #00d2ff, #0072ff); color: #fff; border: none; padding: 10px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-locked { background: #333 !important; color: #777 !important; cursor: not-allowed; }
        .btn-ad { background: linear-gradient(135deg, #ffd700, #ffa500); color: #000; }
        
        canvas { display: block; }
    </style>
</head>
<body>

    <div id="top-ui">
        <div class="stat-box" style="color:#00f2ff;">üí∞ $<span id="coins">0.000000</span></div>
        <div class="stat-box" style="color:#ffd700;">‚ö° <span id="energy-count">5</span>/5</div>
        <div class="stat-box" style="color:#ff00e6;">üíé <span id="dia-count">0</span></div>
    </div>

    <div id="sea-shop" class="modal">
        <button class="close-btn" onclick="closeAll()">√ó</button>
        <h3 style="color:#00f2ff;">‚öì SEA SHOP</h3>
        <div id="level-list"></div>
    </div>

    <div id="ad-modal" class="modal">
        <h3 style="color:#ffd700;">‚ö° ‡¶è‡¶®‡¶æ‡¶∞‡ßç‡¶ú‡¶ø ‡¶∂‡ßá‡¶∑!</h3>
        <p>‡¶®‡¶§‡ßÅ‡¶® ‡ß´‡¶ü‡¶ø ‡¶è‡¶®‡¶æ‡¶∞‡ßç‡¶ú‡¶ø ‡¶™‡ßá‡¶§‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§</p>
        <button class="btn-action btn-ad" onclick="watchAd()">üì∫ WATCH AD (GET 5‚ö°)</button>
    </div>

    <div id="nav-bar">
        <div class="nav-item" onclick="alert('Coming Soon')"><span style="font-size:20px;">üë•</span><span class="nav-text">Refer</span></div>
        <div class="nav-item" onclick="openShop('sea-shop')"><span style="font-size:20px;">üõí</span><span class="nav-text">Shop</span></div>
        <div class="nav-item" onclick="watchAd()"><span style="font-size:20px;">üíé</span><span class="nav-text">Ads</span></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const user = tg.initDataUnsafe?.user;
        const userId = user ? user.id.toString() : "test_user_88";

        const firebaseConfig = {
            apiKey: "AIzaSyA-2VRyhIktuWhesvHRa2lkq-G-PRWBQ8S5RP",
            databaseURL: "https://royaldiamondbot-default-rtdb.firebaseio.com",
            projectId: "royaldiamondbot",
            appId: "1:156914195366:web:e5ab56df62ecbf90550d67"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let balance = 0, energy = 5, diamonds = 0, currentLvl = 1;
        let fishes = [];
        const levels = [
            {id: 1, fish: 4, price: 0, depth: 2000},
            {id: 2, fish: 8, price: 2.0, depth: 3000},
            {id: 3, fish: 12, price: 3.0, depth: 4000},
            {id: 4, fish: 16, price: 4.0, depth: 5000},
            {id: 5, fish: 20, price: 5.0, depth: 6000}
        ];

        db.ref('users/' + userId).once('value').then((snap) => {
            const val = snap.val();
            if(val) {
                balance = val.balance || 0;
                energy = (val.energy !== undefined) ? val.energy : 5;
                diamonds = val.diamonds || 0;
                currentLvl = val.level || 1;
                updateUI();
                if(energy <= 0) document.getElementById('ad-modal').style.display = 'block';
            }
        });

        function saveData() {
            db.ref('users/' + userId).update({ balance, energy, diamonds, level: currentLvl });
        }

        function updateUI() {
            document.getElementById("coins").innerText = balance.toFixed(6);
            document.getElementById("energy-count").innerText = energy;
            document.getElementById("dia-count").innerText = diamonds;
        }

        function openShop(id) { closeAll(); document.getElementById(id).style.display = "block"; if(id==='sea-shop') renderShop(); }
        function closeAll() { document.querySelectorAll('.modal').forEach(m => m.style.display="none"); }

        function renderShop() {
            document.getElementById("level-list").innerHTML = levels.map(l => {
                let statusText = "";
                let btnClass = "btn-action";
                let btnAction = "";

                if (l.id <= currentLvl) {
                    statusText = "OWNED";
                    btnClass += " btn-locked"; // ‡¶ï‡ßá‡¶®‡¶æ ‡¶π‡ßü‡ßá ‡¶ó‡ßá‡¶õ‡ßá
                } else if (l.id === currentLvl + 1) {
                    statusText = "$" + l.price.toFixed(2); // ‡¶ï‡ßá‡¶®‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá
                    btnAction = `onclick="buyLvl(${l.price}, ${l.id})"`;
                } else {
                    statusText = "LOCKED"; // ‡¶è‡¶ñ‡¶®‡¶ì ‡¶∏‡¶Æ‡ßü ‡¶π‡ßü‡¶®‡¶ø
                    btnClass += " btn-locked";
                }

                return `
                <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:8px; border-radius:12px; margin-bottom:8px; border: 1px solid rgba(0,242,255,0.1);">
                    <div style="text-align:left;"><b>Level ${l.id}</b><br><small>${l.fish} Fish | ${l.depth}m</small></div>
                    <button class="${btnClass}" style="width:auto; padding:5px 10px;" ${btnAction}>${statusText}</button>
                </div>`;
            }).join('');
        }

        function buyLvl(p, id) {
            if (balance >= p) {
                balance -= p;
                currentLvl = id;
                saveData();
                renderShop();
                updateUI();
                alert("Level " + id + " Unlocked!");
            } else {
                alert("Insufficient Balance!");
            }
        }

        function watchAd() {
            alert("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶∏‡¶´‡¶≤! ‡ß´‡¶ü‡¶ø ‡¶è‡¶®‡¶æ‡¶∞‡ßç‡¶ú‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§");
            energy = 5;
            document.getElementById('ad-modal').style.display = 'none';
            updateUI(); saveData();
        }

        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let hook = { x: canvas.width / 2, y: 80, state: 'idle' };

        function draw() {
            let grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
            grad.addColorStop(0, "#00a8e8"); grad.addColorStop(1, "#001e30");
            ctx.fillStyle = grad; ctx.fillRect(0, 0, canvas.width, canvas.height);

            if(hook.state === 'dropping') {
                hook.y += 10; if(hook.y > canvas.height - 180) hook.state = 'retracting';
            } else if(hook.state === 'retracting') {
                hook.y -= 10;
                if(hook.y <= 80) {
                    hook.state = 'idle';
                    let caught = fishes.filter(f => f.caught);
                    if(caught.length > 0) { balance += caught.length * 0.00005; saveData(); fishes = fishes.filter(f => !f.caught); updateUI(); }
                }
            }

            ctx.strokeStyle = "white"; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(canvas.width / 2, 0); ctx.lineTo(hook.x, hook.y); ctx.stroke();
            ctx.beginPath(); ctx.arc(hook.x, hook.y + 12, 12, 0, Math.PI); ctx.stroke();

            let cfg = levels[currentLvl-1];
            while(fishes.length < cfg.fish) {
                fishes.push({ x: Math.random()*canvas.width, y: 250+Math.random()*(canvas.height-450), speed: 1.5+Math.random()*1.5, dir: Math.random()>0.5?1:-1, caught: false, color: `hsl(${Math.random()*360}, 70%, 60%)` });
            }

            fishes.forEach(f => {
                if(f.caught) { f.x = hook.x; f.y = hook.y + 25; }
                else {
                    f.x += f.speed * f.dir;
                    if(f.x > canvas.width + 20) f.dir = -1; if(f.x < -20) f.dir = 1;
                    if(hook.state === 'retracting' && Math.hypot(hook.x-f.x, hook.y-f.y) < 35) f.caught = true;
                }
                ctx.fillStyle = f.color; ctx.beginPath(); ctx.ellipse(f.x, f.y, 18, 9, 0, 0, Math.PI*2); ctx.fill();
            });
            requestAnimationFrame(draw);
        }

        window.onclick = (e) => {
            if(document.getElementById('ad-modal').style.display === 'block' || document.getElementById('sea-shop').style.display === 'block' || e.target.closest('#nav-bar')) return;
            if(hook.state === 'idle') {
                if(energy > 0) { hook.state = 'dropping'; energy--; updateUI(); saveData(); }
                else { document.getElementById('ad-modal').style.display = 'block'; }
            }
        };
        draw();
    </script>
</body>
</html>

