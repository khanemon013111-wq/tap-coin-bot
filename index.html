<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fishing Pro - Realistic Hook Update</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        body { margin: 0; padding: 0; background: #001e30; overflow: hidden; touch-action: none; font-family: 'Segoe UI', sans-serif; color: white; }
        
        #banner-ad-box {
            position: fixed;
            bottom: 65px; 
            width: 100%;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1500;
            background: rgba(0,0,0,0.2);
            pointer-events: auto;
        }

        #top-ui { position: fixed; top: 10px; width: 100%; display: flex; justify-content: center; gap: 8px; z-index: 100; pointer-events: none; }
        .stat-box { background: rgba(0, 30, 50, 0.9); padding: 5px 12px; border-radius: 12px; border: 1px solid rgba(0, 242, 255, 0.3); font-weight: bold; font-size: 11px; display: flex; align-items: center; gap: 4px; }
        
        #force-lock { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 10000; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        #lock-info-text { font-size: 20px; font-weight: bold; color: #ff4757; margin-bottom: 20px; }

        .modal { display: none; position: fixed; top: 45%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 20, 35, 0.98); padding: 25px; border-radius: 25px; border: 2px solid #00f2ff; z-index: 3000; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 0 20px rgba(0, 242, 255, 0.2); max-height: 70vh; overflow-y: auto; }
        .close-btn { position: absolute; top: 10px; right: 15px; background: #ff4757; color: white; border: none; width: 28px; height: 28px; border-radius: 50%; font-weight: bold; cursor: pointer; }
        .btn-action { background: linear-gradient(135deg, #00d2ff, #0072ff); color: #fff; border: none; padding: 12px; width: 100%; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 14px; }

        .btn-gray { background: #444 !important; color: #888 !important; cursor: not-allowed; }
        .task-card { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 15px; margin-bottom: 12px; border: 1px solid rgba(0,242,255,0.1); }
        
        #nav-bar { position: fixed; bottom: 0; width: 100%; height: 65px; background: rgba(0, 15, 25, 0.98); border-top: 1.5px solid rgba(0, 242, 255, 0.3); display: flex; justify-content: space-around; align-items: center; z-index: 2000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #00f2ff; cursor: pointer; flex: 1; }
        .nav-text { font-size: 10px; font-weight: bold; margin-top: 4px; }
        canvas { display: block; }
    </style>
</head>
<body>

    <script src="https://pl28355732.effectivegatecpm.com/a8/fe/bd/a8febd56aaf107a403bd203fa2d55338.js"></script>

    <div id="force-lock">
        <div id="lock-info-text">‚è≥ PROCESSING AD...</div>
        <p style="color: #aaa; font-size: 14px; margin-bottom: 25px;">Please wait for 15 seconds. Don't close the ad.</p>
        <button id="re-open-btn" class="btn-action" style="width:240px; background:#ffd700; color:#000;" onclick="reOpenAd()">üöÄ RE-OPEN AD PAGE</button>
    </div>

    <div id="top-ui">
        <div class="stat-box">üí∞ $<span id="coins">0.000000</span></div>
        <div class="stat-box">‚ö° <span id="energy-count">15</span>/15</div>
        <div class="stat-box">üíé <span id="dia-count">0</span></div>
    </div>

    <div id="banner-ad-box">
        <script type="text/javascript">
            atOptions = { 'key' : '31538927255dfc639a3be82f8f45a1de', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/31538927255dfc639a3be82f8f45a1de/invoke.js"></script>
    </div>

    <div id="tasks-modal" class="modal">
        <button class="close-btn" onclick="closeAll()">√ó</button>
        <h3 style="color:#00f2ff;">üöÄ EARN TASKS</h3>
        <div class="task-card">
            <p style="font-size:12px; margin:0;">Task 1: Join Telegram ($0.20)</p>
            <button id="btn-t1" class="btn-action" onclick="doLinkTask('t1', 'https://t.me/FishingProCommunity')">JOIN CHANNEL</button>
        </div>
        <div class="task-card">
            <p style="font-size:12px; margin:0;">Task 2: Subscribe YouTube ($0.20)</p>
            <button id="btn-t2" class="btn-action" onclick="doLinkTask('t2', 'https://www.youtube.com/@FishProZoneYT')">SUBSCRIBE NOW</button>
        </div>
        <div class="task-card">
            <p style="font-size:12px; margin:0;">Task 3: Watch Video ($0.05)</p>
            <div id="t3-ui">
                <button class="btn-action" style="background:#ff4757;" onclick="window.open('https://youtu.be/Ldj9ogISEBU', '_blank')">WATCH VIDEO</button>
                <input type="text" id="v-code-input" placeholder="Enter Code" style="margin-top:10px; width: 90%; background: #000; color: #fff; border: 1px solid #00f2ff; padding: 10px;">
                <button class="btn-action" onclick="verifyVideoCode()">SUBMIT CODE</button>
            </div>
            <p id="t3-wait" style="display:none; color:#ffd700; font-size:11px;">‚è≥ New video coming soon...</p>
        </div>
    </div>

    <div id="energy-modal" class="modal">
        <h3 style="color:#ffd700;">‚ö° NO ENERGY!</h3>
        <p style="font-size:12px; color:#aaa;">Watch ad to refill 15 energy.</p>
        <button class="btn-action" onclick="startAd('energy')">üì∫ WATCH AD TO REFILL</button>
    </div>

    <div id="diamond-modal" class="modal">
        <button class="close-btn" onclick="closeAll()">√ó</button>
        <h3 style="color:#ff00e6;">üíé DIAMOND TASK</h3>
        <p style="font-size:12px; color:#aaa;">1 Ad = 5 Diamonds (Max 3 turns)</p>
        <button id="dia-ad-btn" class="btn-action" onclick="startAd('dia')">üì∫ WATCH AD (<span id="task-count">3</span>/3)</button>
        <div id="cooldown-area" style="display:none; margin-top:15px;">
            <p id="cooldown-timer" style="color:#00f2ff; font-size:22px; font-weight:bold;">05:00</p>
        </div>
    </div>

    <div id="refer-modal" class="modal">
        <button class="close-btn" onclick="closeAll()">√ó</button>
        <h3 style="color:#ffd700;">üë• REFERRAL</h3>
        <p style="font-size: 11px; color: #00f2ff;">Invite friend & get $0.05 Bonus!</p>
        <div id="refer-link-box" style="font-size:11px; padding:15px; border:1px dashed #00f2ff; color:#00f2ff; word-break:break-all; border-radius:10px; margin-top:10px;">Loading...</div>
        <button class="btn-action" onclick="copyReferLink()">COPY LINK</button>
    </div>

    <div id="withdraw-modal" class="modal">
        <button class="close-btn" onclick="closeAll()">√ó</button>
        <h3 style="color:#27ae60;">üí∏ WITHDRAW</h3>
        <input type="number" id="binance-uid" placeholder="Binance UID" style="width: 90%; background: #000; color: #fff; border: 1px solid #27ae60; padding: 10px; margin-bottom: 10px;">
        <select id="withdraw-amount" style="width: 90%; background: #000; color: #fff; border: 1px solid #27ae60; padding: 10px;">
            <option value="5000">5.00 USD (5k Diamonds)</option>
            <option value="10000">10.00 USD (10k Diamonds)</option>
        </select>
        <button class="btn-action" style="background: #27ae60;" onclick="submitWithdraw()">SUBMIT REQUEST</button>
    </div>

    <div id="nav-bar">
        <div class="nav-item" onclick="openShop('tasks-modal')"><span>üöÄ</span><span class="nav-text">Tasks</span></div>
        <div class="nav-item" onclick="openShop('refer-modal')"><span>üë•</span><span class="nav-text">Refer</span></div>
        <div class="nav-item" onclick="openShop('withdraw-modal')"><span>üí∞</span><span class="nav-text">Wallet</span></div>
        <div class="nav-item" onclick="openShop('diamond-modal')"><span>üíé</span><span class="nav-text">Diamond</span></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const ADSTERRA_SMARTLINK = "https://www.effectivegatecpm.com/rarb5qds06?key=79349eb6a9357e2e416a3ef19425a5c1";
        const tg = window.Telegram.WebApp;
        tg.expand();
        const userId = tg.initDataUnsafe?.user?.id ? tg.initDataUnsafe.user.id.toString() : "test_user";
        const refererId = tg.initDataUnsafe?.start_param ? tg.initDataUnsafe.start_param.toString() : null;

        const firebaseConfig = {
            apiKey: "AIzaSyA-2VRyhIktuWhesvHRa2lkq-G-PRWBQ8S5RP",
            databaseURL: "https://royaldiamondbot-default-rtdb.firebaseio.com",
            projectId: "royaldiamondbot",
            appId: "1:156914195366:web:e5ab56df62ecbf90550d67"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let balance = 0, energy = 15, diamonds = 0, tasksDone = 0, nextResetTime = 0;
        let t1_done = false, t2_done = false;
        let last_v_id = 0; 
        let adStartTime = 0, timerActive = false, rewardType = "";
        let hookThrowCount = 0;
        let fishes = [];

        let currentVideoID = 1; 
        let correctCode = "23899"; 

        function checkReferralBonus() {
            setTimeout(() => {
                const myPath = db.ref('users/' + userId);
                myPath.once('value').then((snap) => {
                    if (!snap.exists()) {
                        if (refererId && refererId !== userId) {
                            const bossPath = db.ref('users/' + refererId);
                            bossPath.once('value').then((bossSnap) => {
                                if (bossSnap.exists()) {
                                    let bossBal = parseFloat(bossSnap.val().balance || 0);
                                    bossPath.update({ balance: bossBal + 0.05 });
                                }
                            });
                        }
                        myPath.set({ balance: 0.0, energy: 15, diamonds: 0, tasksDone: 0, joined: Date.now(), last_v_id: 0 });
                    }
                });
            }, 3000);
        }

        function startAd(type) {
            if (type === 'dia' && tasksDone >= 3) return;
            rewardType = type; 
            adStartTime = Date.now(); 
            timerActive = true;
            window.open(ADSTERRA_SMARTLINK, '_blank');
            closeAll();
            document.getElementById("force-lock").style.display = "flex";
        }

        function reOpenAd() { window.open(ADSTERRA_SMARTLINK, '_blank'); }

        setInterval(() => {
            if (nextResetTime > 0) {
                let diff = Math.floor((nextResetTime - Date.now()) / 1000);
                if (diff <= 0) { tasksDone = 0; nextResetTime = 0; saveData(); document.getElementById("cooldown-area").style.display = "none"; }
                else {
                    let m = Math.floor(diff/60); let s = diff%60;
                    document.getElementById("cooldown-timer").innerText = `${m}:${s.toString().padStart(2,'0')}`;
                    document.getElementById("cooldown-area").style.display = "block";
                }
            }
            if (timerActive) {
                let elapsed = (Date.now() - adStartTime) / 1000;
                if (elapsed >= 15.2) { 
                    timerActive = false;
                    document.getElementById("force-lock").style.display = "none";
                    if(rewardType === 'dia') { 
                        diamonds += 5; // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡ßß‡ß¶ ‡¶õ‡¶ø‡¶≤, ‡ß´ ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
                        tasksDone++; 
                        if(tasksDone >= 3) nextResetTime = Date.now() + (5 * 60 * 1000); 
                    }
                    else if(rewardType === 'energy') { energy = 15; }
                    saveData();
                    alert("Reward Added!");
                }
            }
        }, 1000);

        function drawOriginalHook(ctx, x, y) {
            ctx.save(); ctx.strokeStyle = "silver"; ctx.lineWidth = 3; ctx.lineCap = "round";
            ctx.beginPath(); ctx.moveTo(x, y - 20); ctx.lineTo(x, y + 5);
            ctx.arc(x - 6, y + 5, 6, 0, Math.PI, false); ctx.lineTo(x - 12, y - 2); ctx.stroke();
            ctx.lineWidth = 1.5; ctx.beginPath(); ctx.arc(x, y - 22, 3, 0, Math.PI * 2); ctx.stroke(); ctx.restore();
        }

        function drawRealisticFish(ctx, f, camY) {
            ctx.save(); ctx.translate(f.x, f.y - camY); if (f.dir === -1) ctx.scale(-1, 1);
            let g = ctx.createRadialGradient(0, 0, 5, 0, 0, 25); g.addColorStop(0, f.color); g.addColorStop(1, "rgba(0,0,0,0.5)");
            ctx.fillStyle = g; ctx.beginPath(); ctx.moveTo(25, 0); ctx.quadraticCurveTo(10, -18, -15, -8); 
            ctx.lineTo(-20, -12); ctx.lineTo(-15, -5); ctx.quadraticCurveTo(-25, 0, -15, 5); 
            ctx.lineTo(-20, 12); ctx.lineTo(-15, 8); ctx.quadraticCurveTo(10, 18, 25, 0); ctx.fill();
            let w = Math.sin(Date.now() * 0.01 + f.x) * 6; ctx.beginPath(); ctx.moveTo(-20, 0); ctx.lineTo(-35, -15+w); ctx.lineTo(-30, 0); ctx.lineTo(-35, 15-w); ctx.fill();
            ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(16, -4, 4, 0, 7); ctx.fill();
            ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(18, -4, 2, 0, 7); ctx.fill(); ctx.restore();
        }

        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let hook = { x: canvas.width/2, y: 80, state: 'idle' };
        const WATER_DEPTH = 2500; let cameraY = 0;

        function createFish() {
            return { x: Math.random()*canvas.width, y: 400 + Math.random()*(WATER_DEPTH - 600), speed: 0.7+Math.random()*0.8, dir: Math.random()>0.5?1:-1, color: `hsl(${Math.random()*360}, 80%, 50%)`, caught: false };
        }
        for(let i=0; i<25; i++) fishes.push(createFish());

        function draw() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            if (hook.y > canvas.height / 2) cameraY = (hook.y - canvas.height / 2); else cameraY = 0;
            if (cameraY > WATER_DEPTH - canvas.height) cameraY = WATER_DEPTH - canvas.height;
            let b = ctx.createLinearGradient(0, -cameraY, 0, WATER_DEPTH - cameraY);
            b.addColorStop(0,"#00a8e8"); b.addColorStop(0.5,"#001e30"); b.addColorStop(1,"#00050a"); ctx.fillStyle = b; ctx.fillRect(0,0,canvas.width, canvas.height);
            if(hook.state === 'dropping') { hook.y += 6; if(hook.y > WATER_DEPTH - 150) hook.state = 'retracting'; }
            else if(hook.state === 'retracting') { hook.y -= 7; if(hook.y <= 80) { hook.state = 'idle'; checkCatch(); } }
            ctx.strokeStyle = "rgba(255,255,255,0.5)"; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(canvas.width/2, -cameraY); ctx.lineTo(hook.x, hook.y - cameraY - 20); ctx.stroke();
            drawOriginalHook(ctx, hook.x, hook.y - cameraY);
            fishes.forEach(f => {
                if(f.caught) { f.x = hook.x; f.y = hook.y + 15; }
                else { f.x += f.speed * f.dir; if(f.x > canvas.width+50) f.dir = -1; if(f.x < -50) f.dir = 1; if(hook.state === 'retracting' && Math.hypot(hook.x-f.x, hook.y-f.y) < 30) f.caught = true; }
                drawRealisticFish(ctx, f, cameraY);
            });
            requestAnimationFrame(draw);
        }

        function checkCatch() {
            let c = fishes.filter(f => f.caught).length;
            if(c > 0) { 
                balance += c * 0.00005; 
                fishes = fishes.filter(f => !f.caught); 
                while(fishes.length < 25) fishes.push(createFish()); 
                saveData(); 
            }
        }

        window.onclick = (e) => {
            if(e.target.tagName !== 'CANVAS' || hook.state !== 'idle' || timerActive) return;
            if(energy <= 0) { openShop('energy-modal'); return; }
            hook.state = 'dropping'; energy--; hookThrowCount++;
            if(hookThrowCount >= 100) { hookThrowCount = 0; startAd('auto'); }
            saveData();
        };

        function doLinkTask(type, link) {
            window.open(link, '_blank');
            setTimeout(() => {
                if(type === 't1' && !t1_done) { balance += 0.20; t1_done = true; }
                if(type === 't2' && !t2_done) { balance += 0.20; t2_done = true; }
                saveData(); alert("Success!");
            }, 3500);
        }

        function verifyVideoCode() {
            let input = document.getElementById("v-code-input").value;
            if(input === correctCode) {
                balance += 0.05; 
                last_v_id = currentVideoID;
                saveData(); 
                alert("Success!"); 
            } else { alert("Wrong Code!"); }
        }

        function saveData() { db.ref('users/' + userId).update({ balance, energy, diamonds, tasksDone, nextResetTime, t1_done, t2_done, last_v_id }); }
        
        db.ref('users/' + userId).on('value', snap => {
            const v = snap.val(); if(v) {
                balance = v.balance || 0; energy = v.energy ?? 15; diamonds = v.diamonds || 0; tasksDone = v.tasksDone || 0; nextResetTime = v.nextResetTime || 0;
                t1_done = v.t1_done || false; t2_done = v.t2_done || false;
                last_v_id = v.last_v_id || 0;

                document.getElementById("coins").innerText = balance.toFixed(6);
                document.getElementById("energy-count").innerText = energy;
                document.getElementById("dia-count").innerText = diamonds;
                document.getElementById("task-count").innerText = Math.max(0, 3 - tasksDone);
                document.getElementById("refer-link-box").innerText = `https://t.me/Referralincamebd01311_bot/play?startapp=${userId}`;
                
                if(t1_done) { let b=document.getElementById("btn-t1"); b.innerText="DONE"; b.classList.add("btn-gray"); b.disabled=true; }
                if(t2_done) { let b=document.getElementById("btn-t2"); b.innerText="DONE"; b.classList.add("btn-gray"); b.disabled=true; }
                
                if(last_v_id >= currentVideoID) {
                    document.getElementById("t3-ui").style.display="none"; 
                    document.getElementById("t3-wait").style.display="block"; 
                } else {
                    document.getElementById("t3-ui").style.display="block"; 
                    document.getElementById("t3-wait").style.display="none";
                }
            }
        });

        checkReferralBonus();

        function copyReferLink() { navigator.clipboard.writeText(document.getElementById("refer-link-box").innerText).then(() => alert("Copied!")); }
        function openShop(id) { closeAll(); document.getElementById(id).style.display = "block"; }
        function closeAll() { document.querySelectorAll('.modal').forEach(m => m.style.display = "none"); }
        function submitWithdraw() {
            const u = document.getElementById('binance-uid').value;
            const a = parseInt(document.getElementById('withdraw-amount').value);
            if(!u || diamonds < a) return alert("Check Balance!");
            db.ref('Withdraw_Requests').push({userId, binanceUID: u, diamondAmount: a, status: "Pending", timestamp: Date.now()});
            diamonds -= a; saveData(); closeAll(); alert("Requested!");
        }
        draw();
    </script>
</body>
                </html>
